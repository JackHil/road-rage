#!/bin/bash
# Must be run from the base AORTA directory, eg,
# ./tools/auction_experiment all big_btr 7500

COMMAND=$1
MAP=$2
SPAWN_PER_HOUR=$3
GENERATIONS="3"
MAX_BUDGET="300"
NO_SYS="--cfg_wallets thruput_bonus=0 avail_capacity_threshold=0 capacity_bonus=0 dependency_rate=0 waiting_rate=0 ready_rate=0"

if [[ -z $COMMAND || -z $MAP ]]; then
  echo "Usage: ./tools/auction_experiment fifo big_btr 7500"
  exit
fi

BASE="scenarios/${MAP}"

if [[ $COMMAND != "fifo" && $COMMAND != "all" && ! -f ${BASE}-fifo ]]; then
  echo "First need to make ${BASE}-fifo"
  echo "Try: ./tools/auction_experiment fifo $MAP 7500"
  exit
fi

# TODO all one type of policy

case $COMMAND in
  # The base-line... FCFS ordering
  "fifo")
    ./experiment maps/${MAP}.map --spawn ${SPAWN_PER_HOUR} delay=3600 \
      generations=${GENERATIONS} lifetime=3600 budget=0-${MAX_BUDGET} \
      --out ${BASE}-fifo
    ;;

  # Regular auctions
  "auction-sys")
    ./experiment ${BASE}-fifo --out ${BASE}-auction-sys --all_verts \
      ordering=Auction
    ;;
  "auction-no-sys")
    ./experiment ${BASE}-fifo --out ${BASE}-auction-no-sys ${NO_SYS} \
      --all_verts ordering=Auction
    ;;

  # Every agent is weighted equally
  "equal-sys")
    ./experiment ${BASE}-fifo --out ${BASE}-equal-sys --all_agents \
      wallet=Static budget=1-1 --all_verts ordering=Auction
    ;;
  "equal-no-sys")
    ./experiment ${BASE}-fifo --out ${BASE}-equal-no-sys --all_agents \
      wallet=Static budget=1-1 ${NO_SYS} --all_verts ordering=Auction
    ;;

  # Every agent always bids their priority without losing money
  "fixed-sys")
    ./experiment ${BASE}-fifo --out ${BASE}-fixed-sys --all_agents \
      wallet=Static --all_verts ordering=Auction
    ;;
  "fixed-no-sys")
    ./experiment ${BASE}-fifo --out ${BASE}-fixed-no-sys --all_agents \
      wallet=Static ${NO_SYS} --all_verts ordering=Auction
    ;;

  "all")
    ./tools/auction_experiment fifo           ${MAP} ${SPAWN_PER_HOUR}
    ./tools/auction_experiment auction-sys    ${MAP} ${SPAWN_PER_HOUR}
    ./tools/auction_experiment auction-no-sys ${MAP} ${SPAWN_PER_HOUR}
    ./tools/auction_experiment equal-sys      ${MAP} ${SPAWN_PER_HOUR}
    ./tools/auction_experiment equal-no-sys   ${MAP} ${SPAWN_PER_HOUR}
    ./tools/auction_experiment fixed-sys      ${MAP} ${SPAWN_PER_HOUR}
    ./tools/auction_experiment fixed-no-sys   ${MAP} ${SPAWN_PER_HOUR}
    ;;

  *)
    echo "Invalid command ${COMMAND}"
    ;;
esac
