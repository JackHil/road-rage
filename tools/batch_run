#!/usr/bin/python2

# TODO elegant shutdown

import multiprocessing
import subprocess
import sys

PER_HOUR = '20000'
CITIES = ['austin', 'baton_rouge', 'seattle', 'sf']
MODES = ['fifo', 'auction-sys', 'auction-no-sys', 'equal-sys', 'equal-no-sys',
         'fixed-sys', 'fixed-no-sys']
TRIALS = 5
THREADS = 4

class Worker(multiprocessing.Process):
  def __init__(self, queue):
    multiprocessing.Process.__init__(self)
    self.queue = queue

  def run(self):
    while not self.queue.empty():
      job = self.queue.get()
      try:
        print >> sys.stderr, "Running", job
        subprocess.call(job, shell=True)
        print >> sys.stderr, job, "is done"
      except:
        print sys.stderr, job, "Problem!"
      queue.task_done()

if __name__ == '__main__':
  queue = multiprocessing.JoinableQueue()
  command = sys.argv[1]
  for city in CITIES:
    for trial_num in xrange(1, TRIALS + 1):
      trial = str(trial_num)
      if command == 'generate':
        queue.put(
          './tools/auction_experiment all ' + city + ' ' + PER_HOUR + ' ' + trial
        )
      for mode in MODES:
        if command == 'run':
          queue.put('./tools/run ' + city + '-' + trial + '-' + mode)
        if command == 'finalize':
          queue.put('./tools/finalize ' + city + '-' + trial + '-' + mode)

  for i in xrange(THREADS):
    worker = Worker(queue)
    worker.start()

  queue.join()
